const SDK_VERSION="0.2.1",QUEUE_NAME="_ptq",ANON_KEY="__pt_anonymous_id",USER_KEY="__pt_user_id",SESSION_KEY="__pt_session_id",SESSION_LAST_KEY="__pt_session_last",SESSION_IDLE_MS=18e5,MAX_BATCH=200,FLUSH_INTERVAL_MS=5e3,SCROLL_MILESTONES=[25,50,75,100],MAX_TEXT_LEN=80,state={meta:{project_id:null,cdnBase:null,tagVersion:null},config:{collectUrl:null,debug:!1,consentAnalytics:!0,trackPageViews:!0,trackClicks:!0,trackScroll:!0,trackErrors:!0,sampleRate:1,useBeaconOnUnload:!0,includeQueryHash:!1},sampleSeed:null,sampledIn:!0,userId:null,entryReferrer:null,currentUrl:null,previousUrl:null,webVitals:{}};function now(){return Date.now()}function uuid(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function sanitizeText(e){return e&&"string"==typeof e&&(e=e.replace(/\s+/g," ").trim())?(e.length>80&&(e=e.slice(0,80)+"â€¦"),e=(e=e.replace(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/gi,"[redacted_email]")).replace(/\+?\d[\d\s\-()]{7,}\d/g,"[redacted_phone]")):null}function lsGet(e){try{return localStorage.getItem(e)}catch{return null}}function lsSet(e,t){try{localStorage.setItem(e,t)}catch{}}function lsDel(e){try{localStorage.removeItem(e)}catch{}}function ssGet(e){try{return sessionStorage.getItem(e)}catch{return null}}function ssSet(e,t){try{sessionStorage.setItem(e,t)}catch{}}function getAnonId(){let e=lsGet(ANON_KEY);return e||(e=uuid(),lsSet(ANON_KEY,e)),e}function getSessionId(){try{const e=now(),t=Number(ssGet(SESSION_LAST_KEY)||0);let n=ssGet(SESSION_KEY);return(!n||!t||e-t>18e5)&&(n=uuid(),ssSet(SESSION_KEY,n)),ssSet(SESSION_LAST_KEY,String(e)),n}catch{return uuid()}}function loadUserId(){if(state.userId)return state.userId;const e=lsGet(USER_KEY);return state.userId=e?String(e):null,state.userId}function setUserIdPersist(e){if(null==e||""===e)return state.userId=null,void lsDel(USER_KEY);state.userId=String(e),lsSet(USER_KEY,state.userId)}function getPageUrl(){if(state.config.includeQueryHash)return window.location.href;const e=new URL(window.location.href);return e.search="",e.hash="",e.toString()}function baseContext(){return{ua:navigator.userAgent,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,screen:{w:window.screen.width,h:window.screen.height,dpr:window.devicePixelRatio||1},viewport:{w:window.innerWidth,h:window.innerHeight},sdk_version:"0.2.1",tag_version:state.meta.tagVersion||null}}function buildEvent(e,t={},n={}){const r=getPageUrl(),s=void 0!==n.previous_url?n.previous_url:state.previousUrl||null;return{project_id:state.meta.project_id,event_name:e,event_ts:now(),anonymous_id:getAnonId(),session_id:getSessionId(),user_id:loadUserId(),page_url:r,page_path:window.location.pathname,page_title:document.title,referrer:state.entryReferrer||document.referrer||null,previous_url:s,context:baseContext(),properties:t,web_vitals:state.webVitals||{}}}const buffer=[];let flushTimer=null;function dbg(...e){state.config.debug&&console.log("[pt-sdk]",...e)}function canSend(){return state.sampledIn&&!1!==state.config.consentAnalytics&&!!state.meta.project_id&&!!state.config.collectUrl}function enqueue(e){canSend()&&(buffer.push(e),buffer.length>=20?flush({reason:"size"}):scheduleFlush())}function scheduleFlush(){flushTimer||(flushTimer=setTimeout(()=>{flushTimer=null,flush({reason:"timer"})},5e3))}function postEnvelope(e,{useBeacon:t=!1}={}){if(window.__pt_debug_events=window.__pt_debug_events||[],window.__pt_debug_events.push(e),t&&navigator.sendBeacon)try{const t=new Blob([JSON.stringify(e)],{type:"application/json"});return void dbg("beacon sent:",navigator.sendBeacon(state.config.collectUrl,t),e)}catch(e){dbg("beacon failed, fallback to fetch",e)}fetch(state.config.collectUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),keepalive:!0}).then(async t=>{if(t.ok)dbg("collect ok:",t.status,"events:",e.events?.length);else{const e=await t.text().catch(()=>"");dbg("collect non-2xx:",t.status,e)}}).catch(e=>dbg("collect failed:",e))}function flush({reason:e}={}){if(!buffer.length)return;if(!canSend())return;const t=buffer.splice(0,buffer.length),n=[];for(let e=0;e<t.length;e+=200)n.push(t.slice(e,e+200));const r=state.config.useBeaconOnUnload&&("pagehide"===e||"hidden"===e);n.forEach(e=>{postEnvelope({project_id:state.meta.project_id,sent_at:now(),events:e},{useBeacon:r})})}function cssPath(e){if(!e||!e.tagName)return null;const t=[];let n=e;for(let e=0;e<4&&n&&n.tagName;e++){let e=n.tagName.toLowerCase();if(n.id){e+=`#${n.id}`,t.unshift(e);break}n.classList&&n.classList.length&&(e+="."+Array.from(n.classList).slice(0,2).join(".")),t.unshift(e),n=n.parentElement}return t.join(">")}function getElementId(e){const t=e?.closest?.("a,button,input,textarea,select,[role='button'],[role='link'],[data-elt]")||e;if(!t)return null;const n=t.closest?.("[data-elt]")||t,r=n.getAttribute?.("data-elt")||n.getAttribute?.("data-testid")||n.getAttribute?.("aria-label")||cssPath(n);return sanitizeText(String(r||""))||r||null}function onClick(e){if(!state.config.trackClicks)return;const t=getElementId(e.target),n=e.target?.closest?.("a,button,input,textarea,select,[role='button'],[role='link'],[data-elt]")||e.target;enqueue(buildEvent("click",{_event_id:uuid(),element_id:t,element_type:n?.tagName?n.tagName.toLowerCase():null,element_role:n?.getAttribute?.("role")||n?.getAttribute?.("data-role")||null,x:e.clientX,y:e.clientY,button:e.button}))}const scrollFired=new Set;function scrollPct(){const e=document.documentElement,t=e.scrollTop||document.body.scrollTop||0,n=e.scrollHeight||document.body.scrollHeight||0,r=e.clientHeight||1;return Math.max(0,Math.min(100,t/Math.max(1,n-r)*100))}function onScroll(){if(!state.config.trackScroll)return;const e=scrollPct();for(const t of SCROLL_MILESTONES)e>=t&&!scrollFired.has(t)&&(scrollFired.add(t),enqueue(buildEvent("scroll",{_event_id:uuid(),scroll_depth:t})))}function onVisibility(){enqueue(buildEvent("visibility",{state:document.visibilityState})),"hidden"===document.visibilityState&&flush({reason:"hidden"})}function handleUrlChange(e,t){const n=getPageUrl(),r=t||state.currentUrl||null;scrollFired.clear(),state.previousUrl=r,state.currentUrl=n,enqueue(buildEvent("route",{kind:e,_event_id:uuid()},{previous_url:r})),state.config.trackPageViews&&enqueue(buildEvent("page_view",{trigger:e,_event_id:uuid()},{previous_url:r}))}function hookHistory(){const e=history.pushState,t=history.replaceState;history.pushState=function(...t){const n=state.currentUrl||getPageUrl(),r=e.apply(this,t);return setTimeout(()=>handleUrlChange("pushState",n),0),r},history.replaceState=function(...e){const n=state.currentUrl||getPageUrl(),r=t.apply(this,e);return setTimeout(()=>handleUrlChange("replaceState",n),0),r},window.addEventListener("popstate",()=>{const e=state.currentUrl||getPageUrl();setTimeout(()=>handleUrlChange("popstate",e),0)}),window.addEventListener("hashchange",()=>{const e=state.currentUrl||getPageUrl();setTimeout(()=>handleUrlChange("hashchange",e),0)})}function hookErrors(){state.config.trackErrors&&(window.addEventListener("error",e=>{const t=sanitizeText(e?.message)||"js_error";enqueue(buildEvent("error",{_event_id:uuid(),error_type:"js",message:t,filename:e?.filename||null,lineno:e?.lineno||null,colno:e?.colno||null,is_fatal:!1}))}),window.addEventListener("unhandledrejection",e=>{const t=sanitizeText(e?.reason?.message||String(e?.reason||""))||"unhandled_promise";enqueue(buildEvent("error",{_event_id:uuid(),error_type:"js",message:t,is_fatal:!1}))}))}function initVitals(){try{const e=performance.getEntriesByType("navigation")[0];if(e&&e.responseStart&&(state.webVitals.ttfb=Math.round(e.responseStart)),window.PerformanceObserver){new PerformanceObserver(e=>{e.getEntries().forEach(e=>{"first-contentful-paint"===e.name&&(state.webVitals.fcp=Math.round(e.startTime))})}).observe({type:"paint",buffered:!0});new PerformanceObserver(e=>{const t=e.getEntries(),n=t[t.length-1];n&&(state.webVitals.lcp=Math.round(n.startTime))}).observe({type:"largest-contentful-paint",buffered:!0});let e=0;new PerformanceObserver(t=>{t.getEntries().forEach(t=>{t.hadRecentInput||(e+=t.value)}),state.webVitals.cls=Number(e.toFixed(4))}).observe({type:"layout-shift",buffered:!0});new PerformanceObserver(e=>{const t=e.getEntries()[0];t&&(state.webVitals.fid=Math.round(t.processingStart-t.startTime))}).observe({type:"first-input",buffered:!0})}}catch{}}function recomputeSampling(){null!==state.sampleSeed&&void 0!==state.sampleSeed||(state.sampleSeed=Math.random());const e="number"==typeof state.config.sampleRate?state.config.sampleRate:1,t=Math.max(0,Math.min(1,e));state.sampledIn=state.sampleSeed<t}function handleCommand(e){if(!Array.isArray(e))return;const[t,n]=e;if("__meta"===t)return state.meta.project_id=n?.project_id||state.meta.project_id,state.meta.cdnBase=n?.cdnBase||state.meta.cdnBase,void(state.meta.tagVersion=n?.tagVersion||state.meta.tagVersion);if("config"===t){if(!n)return;return n.collectUrl&&(state.config.collectUrl=n.collectUrl),"boolean"==typeof n.debug&&(state.config.debug=n.debug),"boolean"==typeof n.trackPageViews&&(state.config.trackPageViews=n.trackPageViews),"boolean"==typeof n.trackClicks&&(state.config.trackClicks=n.trackClicks),"boolean"==typeof n.trackScroll&&(state.config.trackScroll=n.trackScroll),"boolean"==typeof n.trackErrors&&(state.config.trackErrors=n.trackErrors),"boolean"==typeof n.includeQueryHash&&(state.config.includeQueryHash=n.includeQueryHash),void("number"==typeof n.sampleRate&&(state.config.sampleRate=Math.max(0,Math.min(1,n.sampleRate)),recomputeSampling()))}if("consent"!==t)if("setUserId"!==t)if("event"!==t)"flush"===t&&flush({reason:"manual"});else{if(!n||!n.type)return;enqueue(buildEvent(n.type,{_event_id:uuid(),...n.payload||{}}))}else setUserIdPersist(n);else n&&"boolean"==typeof n.analytics&&(state.config.consentAnalytics=n.analytics)}function init(){state.entryReferrer=document.referrer||null,state.currentUrl=getPageUrl(),state.previousUrl=null,loadUserId(),recomputeSampling();const e=window._ptq=window._ptq||[];e.forEach(handleCommand);const t=e.push.bind(e);e.push=function(...e){return e.forEach(handleCommand),t(...e)},initVitals(),state.config.trackClicks&&document.addEventListener("click",onClick,!0),state.config.trackScroll&&window.addEventListener("scroll",onScroll,{passive:!0}),document.addEventListener("visibilitychange",onVisibility),window.addEventListener("pagehide",()=>flush({reason:"pagehide"})),hookHistory(),hookErrors(),state.config.trackPageViews&&enqueue(buildEvent("page_view",{trigger:"initial",_event_id:uuid()},{previous_url:null})),dbg("initialized",{project_id:state.meta.project_id,collectUrl:state.config.collectUrl,consent:state.config.consentAnalytics,sampledIn:state.sampledIn,includeQueryHash:state.config.includeQueryHash})}init();